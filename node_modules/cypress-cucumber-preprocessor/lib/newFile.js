const path = require("path");
const { Parser } = require("gherkin");
const { getStepDefinitionsPaths } = require("./getStepDefinitionsPaths");
const { getCucumberJsonConfig } = require("./getCucumberJsonConfig");
const { log, createCucumber } = require("cypress-cucumber-preprocessor/lib/loader");

// eslint-disable-next-line func-names
module.exports = function (spec, filePath = this.resourcePath) {
  log("compiling", spec);
  const stepDefinitionsToRequire = getStepDefinitionsPaths(filePath).map(
    (sdPath) => `require('${sdPath}')`
  );

  const { name } = new Parser().parse(spec.toString()).feature;
  return createCucumber(
    path.basename(filePath),
    getCucumberJsonConfig(),
    spec,
    stepDefinitionsToRequire,
    name
  );
};
